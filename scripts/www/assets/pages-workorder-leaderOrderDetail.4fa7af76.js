import{r as e,C as a,l,D as t,o as s,c as i,b as o,a as n,t as u,F as r,m as d,w as c,n as p,E as v,v as f,G as m,A as y,e as g,p as b,H as h,J as k,q as I,d as j}from"./index-634fa69d.js";import{_ as L}from"./u-navbar.5a6ebb76.js";import{o as _,a as T,r as w}from"./uni-app.es.78f2cdc8.js";import{_ as x}from"./u-icon.57682e04.js";import{_ as C}from"./u-input.0deae26b.js";import{_ as V,a as $}from"./u-form.9aed71e3.js";import{o as O,_ as R}from"./excel.b0ec50db.js";import{_ as F,a as N}from"./uni-popup.9671773e.js";import{d as S,c as A,h as D}from"./orderDetail.18a8c922.js";import{O as U,i as B}from"./workorder.a3c585f7.js";import{d as K,b as P}from"./common.c1fe3543.js";import{R as q}from"./Record.3dcbcd14.js";import"./FileSaver.min.c18a2d77.js";import{h as E}from"./sso.2a000917.js";import{d as H}from"./index.e8efd85e.js";import{_ as J}from"./_plugin-vue_export-helper.1b428a4d.js";import"./u-line.68a19bb8.js";import"./u-loading-icon.09a3efa7.js";import"./request.87fc902a.js";import"./uni-section.1a5d770b.js";import"./u-tag.3fd9e2ae.js";import"./u-transition.cd342dbb.js";import"./uni-card.d07973b2.js";const z=J({__name:"leaderOrderDetail",setup(J){_((()=>{"notInDingTalk"!==H.env.platform&&H.biz.navigation.setTitle({title:"工单详情"})})),e(!0);const z=e(!0),M=e(),G=e();e([]),e([]);const W=e(),Q=e({procInsId:null,taskId:null,businessKey:null}),X=e(),Y=e(),Z=e(),ee=e(!1),ae=e(!1),le=e(null),te=e(!1),se=e(!1),ie=e(null);async function oe(e){var a;if(console.log("解析后的参数:",e.value),Q.value.procInsId=e&&e.value.processInstanceId,Q.value.taskId=e&&e.value.taskId,Q.value.businessKey=e&&e.value.businessKey,X.value=e&&e.value.processInstanceId,Y.value=e&&e.value.handleType,Z.value=e&&e.value.handleValue,null==Z.value||null==Y.value)return void this.$message.error("请返回刷新后重新处理/查看");const l={procInsId:Q.value.procInsId,taskId:Q.value.taskId},{code:t,data:s}=await S(l);if(200==t){ie.value=null==s?void 0:s.leaderStatus,ee.value=s.toExamine,ae.value=s.toSign,le.value=s.deptId,te.value=s.inOperation,se.value=s.processed,f(),z.value=s.oaOrderVo,ue.value=s.oaOrderHistoryList,z.value.riskLevel=(null==(a=ce.value.find((e=>e.dictValue===z.value.riskLevel)))?void 0:a.dictLabel)||"",M.value=z.value.serviceType;for(let e of re.value)G.value=e.dictValue,G.value===M.value&&(console.log(e.dictLabel,"dictLabel"),W.value=e.dictLabel)}}async function ne(){try{a({title:"加载中",mask:!0});const{code:e,data:l}=await E(z.value.id,Q.value.taskId);200==e&&(f(),ie.value=1,oe(ve),this.$message.success("已阅成功"))}catch(e){f()}finally{f()}}const ue=e({history:[]}),re=e(),de=()=>(m({url:"/pages/workorder/index"}),!0);!async function(){const{data:e}=await U();re.value=e,console.log(re.value,"serviceRange.value");const a=await B();ce.value=a.data,console.log(ce.value,"instructionLevelListData")}();const ce=e([]);const pe=e(),ve=e({});T((e=>{e.params?(a({title:"加载中",mask:!0}),ve.value=JSON.parse(decodeURIComponent(e.params)),oe(ve),pe.value=e.id):uni.$u.toast("请返回刷新后重新处理/查看")}));const fe=e(null),me=e({content:{type:"string",required:!0,message:"请输入",trigger:["blur"]},fileIdList:{required:!0,message:"请上传",trigger:["blur"]}});l((()=>Le.inputFields),(()=>{}));const ye=e(null),ge=e([]),be=async e=>{let a=[].concat(e.file),l=ge.value.length;a.map((e=>{ge.value.push({...e,status:"uploading",message:"上传中"})}));for(let s=0;s<a.length;s++)try{const e=await ke(a[s].url);if(console.log(e,"data1"),200!=e.code){uni.$u.toast(e.msg);let a=l+s;ge.value.splice(a,1),l--;continue}Le.fileIdList.push(e.data);let t=ge.value[l+s];ge.value.splice(l+s,1,{...t,status:"success"})}catch(t){uni.$u.toast("上传失败");let e=l+s;ge.value.splice(e,1),l--}},he=e=>{ge.value.splice(e.index,1),Le.fileIdList.splice(e.index,1)},ke=e=>new Promise(((a,l)=>{h({url:"https://58.20.99.151:9000/dev-api/system/files/upload",filePath:e,name:"file",header:{Authorization:"Bearer "+k("token")},success:e=>{const l=JSON.parse(e.data);a(l)}})}));function Ie(){ye.value.close(),he(event),Le.content=""}function je(){fe.value.validate().then((e=>{e?async function(){try{if(!Z.value)return void uni.$u.toast("保存发生错误，请返回刷新后重新提交");let e=null;e=Array.isArray(Z.value)?JSON.stringify(Z.value):Z.value,Le.value={...Le.value,pendingStatus:Le.pendingStatus,comment:Le.content,taskId:Q.value.taskId,reapprove:!0,handleValue:e,handleType:Y.value,businessKey:Q.value.businessKey,deptIdVue:le.value,inOperation:te.value,processed:se.value,procInsId:X.value,toSign:ae.value,toExamine:ee.value,fileIdList:Le.fileIdList,inputFields:Le.inputFields,vars:"",targetKey:"",modleType:"APP"},await A(Le.value),Ie(),uni.$u.toast("反馈成功"),oe(ve)}catch(e){console.error("提交失败:",e),uni.$u.toast("提交失败，请刷新后重试")}}():uni.$u.toast("请填写完整信息")})).catch((()=>{uni.$u.toast("请填写完整信息")}))}const Le=t({content:"",fileIdList:[],inputFields:[],taskId:null,reapprove:!1,handleValue:null,handleType:null,deptIdVue:null,pendingStatus:1});const _e=e(null);function Te(){_e.value.close()}async function we(){try{const{data:e}=await D(z.value.id,Q.value.taskId);Te(),uni.$u.toast("签收成功"),oe(ve)}catch(e){}}return e([]),(e,a)=>{var l;const t=w(j("up-navbar"),L),f=w(j("u-icon"),x),m=w(j("up-input"),C),h=w(j("up-form-item"),V),k=w(j("up-upload"),R),_=w(j("up-form"),$),T=w(j("uni-popup-dialog"),F),S=w(j("uni-popup"),N),A=y;return s(),i("div",{class:"page-container"},[o(t,{title:"工单详情",onClick:de,"background-color":"#f8f8f8","text-color":"#000"}),n("div",{class:"content"},[n("div",{class:"info-card"},[n("div",{class:"order-header"},[n("div",{class:"title-row"},[n("span",{class:"order-title"},u(z.value.eventTitle),1),"reinsurance_up"===z.value.processType||"reinsurance_in"===z.value.processType?(s(),i("span",{key:0,class:"priority-tag high",style:{width:"78px","text-align":"center"}}," 重保工单 ")):(s(),i("span",{key:1,class:"priority-tag low",style:{width:"78px","text-align":"center"}},"普通工单"))]),n("div",{class:"order-id"},"工单编号:"+u(z.value.orderNo),1)]),n("div",{class:"content-section"},[n("div",{class:"section-title"},"内容"),n("div",{class:"content-text",innerHTML:z.value.remark},null,8,["innerHTML"])]),n("div",{class:"info-grid"},[n("div",{class:"info-item"},[n("div",{class:"info-label"},"工单等级"),n("div",{class:"info-value"},u(z.value.riskLevel),1)]),n("div",{class:"info-item"},[n("div",{class:"info-label"},"业务类型"),n("div",{class:"info-value"},u(W.value),1)]),n("div",{class:"info-item"},[n("div",{class:"info-label"},"反馈超时时间"),n("div",{class:"info-value"},u(z.value.feedbackOutTime),1)]),n("div",{class:"info-item"},[n("div",{class:"info-label"},"签收超时时间"),n("div",{class:"info-value"},u(z.value.responseOutTime),1)])]),n("div",{class:"info-label"},"反馈单位"),n("div",{style:{width:"100%"}},u((null==(l=z.value.cityName)?void 0:l.join())||""),1)]),n("div",{class:"info-card"},[n("div",{class:"section-title"},"附加文件"),n("div",{class:"attachment-list"},[(s(!0),i(r,null,d(z.value.file,((e,a)=>(s(),i("div",{class:"attachment-item",key:a},[n("div",{class:"attachment-name",onClick:a=>function(e){I({url:"/pages/file/preview?fileId="+e.id})}(e)},[o(f,{name:"eye"}),g(u(e.orName),1)],8,["onClick"]),n("div",{class:"attachment-size",onClick:a=>function(e){if(e.id)"notInDingTalk"===H.env.platform?K({id:e.id}).then((a=>{let l="blob";".png"!==e.fileType&&".jpg"!==e.fileType&&".jpeg"!==e.fileType||(l="arraybuffer");const t=new Blob([a],{type:l}),s=URL.createObjectURL(t),i=document.createElement("a");i.style.display="none",i.href=s,i.setAttribute("download",`${e.orName}${e.fileType}`),document.body.appendChild(i),console.log(i,"link"),i.click(),document.body.removeChild(i)})).catch((e=>{console.error("请求失败:",e)})):O("1",e.id,e.fileType,e.orName);else if("notInDingTalk"===H.env.platform){const{orName:a,fileContent:l}=e;P(a,l).then((l=>{let t="blob";".png"!==e.fileType&&".jpg"!==e.fileType&&".jpeg"!==e.fileType||(t="arraybuffer");const s=new Blob([l],{type:t}),i=URL.createObjectURL(s),o=document.createElement("a");o.style.display="none",o.href=i,o.setAttribute("download",`${a}`),document.body.appendChild(o),console.log(o,"link"),o.click(),document.body.removeChild(o)})).catch((e=>{this.$message.error("下载异常请联系管理员")}))}else O("2",e.fileName,e.path)}(e)},[o(f,{name:"download"})],8,["onClick"])])))),128))])]),n("div",{class:"info-card"},[o(q,{history:ue.value},null,8,["history"])])]),o(S,{ref_key:"transferPopupRef",ref:ye,type:"dialog"},{default:c((()=>[o(T,{mode:"input",title:"反馈","before-close":!0,onClose:Ie,onConfirm:je},{default:c((()=>[o(_,{labelPosition:"left",model:b(Le),rules:me.value,labelWidth:"50px",ref_key:"TransferFormRef",ref:fe},{default:c((()=>[o(h,{label:"内容",prop:"content",borderBottom:"",required:""},{default:c((()=>[o(m,{placeholder:"请输入内容",border:"surround",modelValue:b(Le).content,"onUpdate:modelValue":a[0]||(a[0]=e=>b(Le).content=e)},null,8,["modelValue"])])),_:1}),o(h,{label:"上传",prop:"fileList",borderBottom:""},{default:c((()=>[o(k,{fileList:ge.value,onAfterRead:be,onDelete:he,name:"1",multiple:"",maxCount:10,previewFullImage:!0,accept:"file,image"},null,8,["fileList"])])),_:1}),(s(!0),i(r,null,d(b(Le).inputFields,((e,a)=>(s(),p(h,{required:"",key:a,label:e.name,prop:"inputFields["+a+"].value",borderBottom:""},{default:c((()=>[o(m,{placeholder:"请输入内容",border:"surround",modelValue:e.value,"onUpdate:modelValue":a=>e.value=a},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1032,["label","prop"])))),128))])),_:1},8,["model","rules"])])),_:1})])),_:1},512),o(S,{ref_key:"delegatePopupRef",ref:_e,type:"dialog"},{default:c((()=>[o(T,{title:"签收","before-close":!0,onClose:Te,onConfirm:we})])),_:1},512),n("div",{class:"action-bar"},[0==ie.value?(s(),p(A,{key:0,class:"action-btn accept",onClick:ne},{default:c((()=>[g("已阅")])),_:1})):v("",!0)])])}}},[["__scopeId","data-v-7f9814e4"]]);export{z as default};

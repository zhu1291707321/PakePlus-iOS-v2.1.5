import{r as e,C as a,l,D as t,o as s,c as o,b as i,a as n,t as u,F as r,m as d,w as c,n as p,E as v,v as f,G as m,q as y,A as g,e as b,p as h,H as k,J as I,d as j}from"./index-634fa69d.js";import{_}from"./u-navbar.5a6ebb76.js";import{o as L,a as T,r as w}from"./uni-app.es.78f2cdc8.js";import{_ as C}from"./u-icon.57682e04.js";import{_ as x}from"./u-input.0deae26b.js";import{_ as V,a as $}from"./u-form.9aed71e3.js";import{o as O,_ as R}from"./excel.b0ec50db.js";import{_ as N,a as A}from"./uni-popup.9671773e.js";import{d as F,c as D,h as S}from"./orderDetail.18a8c922.js";import{O as U,i as B}from"./workorder.a3c585f7.js";import{d as K,b as P}from"./common.c1fe3543.js";import{R as q}from"./Record.3dcbcd14.js";import"./FileSaver.min.c18a2d77.js";import{d as E}from"./index.e8efd85e.js";import{_ as H}from"./_plugin-vue_export-helper.1b428a4d.js";import"./u-line.68a19bb8.js";import"./u-loading-icon.09a3efa7.js";import"./request.87fc902a.js";import"./uni-section.1a5d770b.js";import"./u-tag.3fd9e2ae.js";import"./u-transition.cd342dbb.js";import"./uni-card.d07973b2.js";const J=H({__name:"orderDetail",setup(H){L((()=>{"notInDingTalk"!==E.env.platform&&E.biz.navigation.setTitle({title:"工单详情"})})),e(!0);const J=e(!0),z=e(),M=e();e([]),e([]);const G=e(),W=e({procInsId:null,taskId:null,businessKey:null}),Q=e(),X=e(),Y=e(),Z=e(!1),ee=e(!1),ae=e(null),le=e(!1),te=e(!1);async function se(e){var a;if(console.log("解析后的参数:",e.value),W.value.procInsId=e&&e.value.processInstanceId,W.value.taskId=e&&e.value.taskId,W.value.businessKey=e&&e.value.businessKey,Q.value=e&&e.value.processInstanceId,X.value=e&&e.value.handleType,Y.value=e&&e.value.handleValue,null==Y.value||null==X.value)return void this.$message.error("请返回刷新后重新处理/查看");const l={procInsId:W.value.procInsId,taskId:W.value.taskId},{code:t,data:s}=await F(l);if(200==t){Z.value=s.toExamine,ee.value=s.toSign,ae.value=s.deptId,le.value=s.inOperation,te.value=s.processed,f(),J.value=s.oaOrderVo,oe.value=s.oaOrderHistoryList,J.value.riskLevel=(null==(a=ue.value.find((e=>e.dictValue===J.value.riskLevel)))?void 0:a.dictLabel)||"",z.value=J.value.serviceType;for(let e of ie.value)M.value=e.dictValue,M.value===z.value&&(console.log(e.dictLabel,"dictLabel"),G.value=e.dictLabel)}}const oe=e({history:[]}),ie=e(),ne=()=>(m({url:"/pages/workorder/index"}),!0);!async function(){const{data:e}=await U();ie.value=e,console.log(ie.value,"serviceRange.value");const a=await B();ue.value=a.data,console.log(ue.value,"instructionLevelListData")}();const ue=e([]);const re=e(),de=e({});T((e=>{e.params?(a({title:"加载中",mask:!0}),de.value=JSON.parse(decodeURIComponent(e.params)),se(de),re.value=e.id):uni.$u.toast("请返回刷新后重新处理/查看")}));const ce=e(null),pe=e({content:{type:"string",required:!0,message:"请输入",trigger:["blur"]},fileIdList:{required:!0,message:"请上传",trigger:["blur"]}});l((()=>Ie.inputFields),(()=>{}));const ve=e(null);function fe(){ve.value.open("center")}const me=e([]),ye=async e=>{let a=[].concat(e.file),l=me.value.length;a.map((e=>{me.value.push({...e,status:"uploading",message:"上传中"})}));for(let s=0;s<a.length;s++)try{const e=await be(a[s].url);if(console.log(e,"data1"),200!=e.code){uni.$u.toast(e.msg);let a=l+s;me.value.splice(a,1),l--;continue}Ie.fileIdList.push(e.data);let t=me.value[l+s];me.value.splice(l+s,1,{...t,status:"success"})}catch(t){uni.$u.toast("上传失败");let e=l+s;me.value.splice(e,1),l--}},ge=e=>{me.value.splice(e.index,1),Ie.fileIdList.splice(e.index,1)},be=e=>new Promise(((a,l)=>{k({url:"https://58.20.99.151:9000/dev-api/system/files/upload",filePath:e,name:"file",header:{Authorization:"Bearer "+I("token")},success:e=>{const l=JSON.parse(e.data);a(l)}})}));function he(){ve.value.close(),ge(event),Ie.content=""}function ke(){ce.value.validate().then((e=>{e?async function(){try{if(!Y.value)return void uni.$u.toast("保存发生错误，请返回刷新后重新提交");let e=null;e=Array.isArray(Y.value)?JSON.stringify(Y.value):Y.value,Ie.value={...Ie.value,pendingStatus:Ie.pendingStatus,comment:Ie.content,taskId:W.value.taskId,reapprove:!0,handleValue:e,handleType:X.value,businessKey:W.value.businessKey,deptIdVue:ae.value,inOperation:le.value,processed:te.value,procInsId:Q.value,toSign:ee.value,toExamine:Z.value,fileIdList:Ie.fileIdList,inputFields:Ie.inputFields,vars:"",targetKey:"",modleType:"APP"},await D(Ie.value),he(),uni.$u.toast("反馈成功"),se(de)}catch(e){console.error("提交失败:",e),uni.$u.toast("提交失败，请刷新后重试")}}():uni.$u.toast("请填写完整信息")})).catch((()=>{uni.$u.toast("请填写完整信息")}))}const Ie=t({content:"",fileIdList:[],inputFields:[],taskId:null,reapprove:!1,handleValue:null,handleType:null,deptIdVue:null,pendingStatus:1});const je=e(null);function _e(){je.value.open("center")}function Le(){je.value.close()}async function Te(){try{const{data:e}=await S(J.value.id,W.value.taskId);Le(),uni.$u.toast("签收成功"),se(de)}catch(e){}}function we(){y({url:"/pages/workorder/Audit?id="+re.value})}return e([]),(e,a)=>{var l;const t=w(j("up-navbar"),_),f=w(j("u-icon"),C),m=w(j("up-input"),x),k=w(j("up-form-item"),V),I=w(j("up-upload"),R),L=w(j("up-form"),$),T=w(j("uni-popup-dialog"),N),F=w(j("uni-popup"),A),D=g;return s(),o("div",{class:"page-container"},[i(t,{title:"工单详情",onClick:ne,"background-color":"#f8f8f8","text-color":"#000"}),n("div",{class:"content"},[n("div",{class:"info-card"},[n("div",{class:"order-header"},[n("div",{class:"title-row"},[n("span",{class:"order-title"},u(J.value.eventTitle),1),"reinsurance_up"===J.value.processType||"reinsurance_in"===J.value.processType?(s(),o("span",{key:0,class:"priority-tag high",style:{width:"78px","text-align":"center"}}," 重保工单 ")):(s(),o("span",{key:1,class:"priority-tag low",style:{width:"78px","text-align":"center"}},"普通工单"))]),n("div",{class:"order-id"},"工单编号:"+u(J.value.orderNo),1)]),n("div",{class:"content-section"},[n("div",{class:"section-title"},"内容"),n("div",{class:"content-text",innerHTML:J.value.remark},null,8,["innerHTML"])]),n("div",{class:"info-grid"},[n("div",{class:"info-item"},[n("div",{class:"info-label"},"工单等级"),n("div",{class:"info-value"},u(J.value.riskLevel),1)]),n("div",{class:"info-item"},[n("div",{class:"info-label"},"业务类型"),n("div",{class:"info-value"},u(G.value),1)]),n("div",{class:"info-item"},[n("div",{class:"info-label"},"反馈超时时间"),n("div",{class:"info-value"},u(J.value.feedbackOutTime),1)]),n("div",{class:"info-item"},[n("div",{class:"info-label"},"签收超时时间"),n("div",{class:"info-value"},u(J.value.responseOutTime),1)])]),n("div",{class:"info-label"},"反馈单位"),n("div",{style:{width:"100%"}},u((null==(l=J.value.cityName)?void 0:l.join())||""),1)]),n("div",{class:"info-card"},[n("div",{class:"section-title"},"附加文件"),n("div",{class:"attachment-list"},[(s(!0),o(r,null,d(J.value.file,((e,a)=>(s(),o("div",{class:"attachment-item",key:a},[n("div",{class:"attachment-name",onClick:a=>function(e){y({url:"/pages/file/preview?fileId="+e.id})}(e)},[i(f,{name:"eye"}),b(u(e.orName),1)],8,["onClick"]),n("div",{class:"attachment-size",onClick:a=>function(e){if(e.id)"notInDingTalk"===E.env.platform?K({id:e.id}).then((a=>{let l="blob";".png"!==e.fileType&&".jpg"!==e.fileType&&".jpeg"!==e.fileType||(l="arraybuffer");const t=new Blob([a],{type:l}),s=URL.createObjectURL(t),o=document.createElement("a");o.style.display="none",o.href=s,o.setAttribute("download",`${e.orName}${e.fileType}`),document.body.appendChild(o),console.log(o,"link"),o.click(),document.body.removeChild(o)})).catch((e=>{console.error("请求失败:",e)})):O("1",e.id,e.fileType,e.orName);else if("notInDingTalk"===E.env.platform){const{orName:a,fileContent:l}=e;P(a,l).then((l=>{let t="blob";".png"!==e.fileType&&".jpg"!==e.fileType&&".jpeg"!==e.fileType||(t="arraybuffer");const s=new Blob([l],{type:t}),o=URL.createObjectURL(s),i=document.createElement("a");i.style.display="none",i.href=o,i.setAttribute("download",`${a}`),document.body.appendChild(i),console.log(i,"link"),i.click(),document.body.removeChild(i)})).catch((e=>{this.$message.error("下载异常请联系管理员")}))}else O("2",e.fileName,e.path)}(e)},[i(f,{name:"download"})],8,["onClick"])])))),128))])]),n("div",{class:"info-card"},[i(q,{history:oe.value},null,8,["history"])])]),i(F,{ref_key:"transferPopupRef",ref:ve,type:"dialog"},{default:c((()=>[i(T,{mode:"input",title:"反馈","before-close":!0,onClose:he,onConfirm:ke},{default:c((()=>[i(L,{labelPosition:"left",model:h(Ie),rules:pe.value,labelWidth:"50px",ref_key:"TransferFormRef",ref:ce},{default:c((()=>[i(k,{label:"内容",prop:"content",borderBottom:"",required:""},{default:c((()=>[i(m,{placeholder:"请输入内容",border:"surround",modelValue:h(Ie).content,"onUpdate:modelValue":a[0]||(a[0]=e=>h(Ie).content=e)},null,8,["modelValue"])])),_:1}),i(k,{label:"上传",prop:"fileList",borderBottom:""},{default:c((()=>[i(I,{fileList:me.value,onAfterRead:ye,onDelete:ge,name:"1",multiple:"",maxCount:10,previewFullImage:!0,accept:"file,image"},null,8,["fileList"])])),_:1}),(s(!0),o(r,null,d(h(Ie).inputFields,((e,a)=>(s(),p(k,{required:"",key:a,label:e.name,prop:"inputFields["+a+"].value",borderBottom:""},{default:c((()=>[i(m,{placeholder:"请输入内容",border:"surround",modelValue:e.value,"onUpdate:modelValue":a=>e.value=a},null,8,["modelValue","onUpdate:modelValue"])])),_:2},1032,["label","prop"])))),128))])),_:1},8,["model","rules"])])),_:1})])),_:1},512),i(F,{ref_key:"delegatePopupRef",ref:je,type:"dialog"},{default:c((()=>[i(T,{title:"签收","before-close":!0,onClose:Le,onConfirm:Te})])),_:1},512),n("div",{class:"action-bar"},[ee.value&&!1===te.value?(s(),p(D,{key:0,class:"action-btn reject",onClick:_e},{default:c((()=>[b("签收")])),_:1})):v("",!0),!0!==te.value||0!=ee.value&&null!=ee.value?v("",!0):(s(),p(D,{key:1,class:"action-btn reject",onClick:fe},{default:c((()=>[b("反馈")])),_:1})),Z.value?(s(),p(D,{key:2,class:"action-btn accept",onClick:we},{default:c((()=>[b("审核")])),_:1})):v("",!0)])])}}},[["__scopeId","data-v-5049a083"]]);export{J as default};
